flowchart TB
    U["User"] --> UI["Chat UI"]
    UI --> ORCH["Chat Orchestrator"]

    %% Optional clarification branch
    ORCH --> GATE["Clarify Gate"]
    GATE -- clarification needed --> Q["Clarification Question"]
    Q --> UI
    GATE -- sufficient info --> EMB

    %% Main recommendation flow
    %%ORCH --> EMB["Query Embedder<br>(preferences → vector)"]

    EMB["Query Embedder<br>(preferences → vector)"] --> VDB[("Chroma Vector DB<br>(shared embedding space)")]
    VDB --> RET["Top-K Similarity Retrieval"]

    RET --> FMT["Results Formatter"]
    FMT --> OUT["Response<br>(ranked items + rationale)"]
    OUT --> UI

    %% External LLM dependency
    EMB -.-|embedding text refinement| LLM["LLM Adapter"]
    FMT -.- LLM

    %% Styling
    classDef core fill:#d7f7d7,stroke:#2e7d32,color:#111
    classDef optional fill:#d6e8ff,stroke:#1e5aa8,color:#111
    classDef llm fill:#fff3cd,stroke:#f0ad4e,color:#111

    U:::core
    UI:::core
    ORCH:::core
    EMB:::core
    VDB:::core
    RET:::core
    FMT:::core
    OUT:::core

    GATE:::optional
    Q:::optional
    LLM:::llm
